---
title: "An outbreak of gastroenteritis in Stegen, Germany, June 1998 (part 2)"
author: "Zhian N. Kamvar, Janetta Skarp, Alexander Spina, and Patrick Keating"
authors: ["Zhian N. Kamvar", "Janetta Skarp", "Alexander Spina", "Patrick Keating"]
categories: ["practicals"]
tags: ["level: beginner", "epicurve", "single variable analysis", "2x2 tables", "reproducible research", "gastroenteritis"]
date: 2018-10-04
slug: stegen-descriptive
licenses: CC-BY
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r stegen_hw_difficult-4, echo = FALSE, results = 'hide'}
tira_data <- read.csv(here::here("data", "tira_clean.csv"), stringsAsFactors = FALSE)
```

```{r stegen_hw_difficult-1, echo = FALSE, eval = FALSE, results = 'hide', message = FALSE, warning = FALSE}
# Installing required packages for the week
required_packages <- c("epiR", "Hmisc", "epitools", "here") 
install.packages(required_packages)
```

```{r stegen_hw_difficult-2, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
library("epiR")
library("Hmisc")
library("epitools")
library("here")
```

```{r stegen_hw_difficult-3, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
# Function to make tables with counts, proportions and cumulative sum
big_table <- function(data, useNA = "no") {
  count <- table(data, useNA = useNA)
  prop <- round(prop.table(count)*100, digits = 2)
  cumulative <- cumsum(prop)
  rbind(count,
        prop,
        cumulative) 
}

 # Function to provide counts, denominator and proportions (equivalent of attack rate)
attack_rate <- function(table) {
  prop <- round(prop.table(table, 1), digits = 2)
  denominator <- rowSums(table) 
  output <- cbind(Ill = table[, 2], N = denominator, Proportions = prop[, 2])
  return(output)
}
```

# Descriptive Analysis

# Question 2
What are the main characteristics of your study population?

### a) Describe your dataset
Look at: 

* the number of observations and variable types
* mean, median, and maximum values for each variable

### b) Create summary tables with counts and proportions
For each variable in the dataset.

### c) Make a box plot and histogram of age

### d) Number of cases by date of onset
Use the incidence package to create an epicurve for this outbreak, providing information on daily incidence. Also create an epicurve stratified by sex.

# Hints
### a) Describe your dataset

You can view the structure of your data set using the following commands:

```{r stegen_hw_difficult-6}
# str provides an overview of the number of observations and variable types
str(tira_data)

# summary provides mean, median and max values of your variables
summary(tira_data)

# describe (from Hmisc package) provides no. of observations, missing values, unique levels of each variable
Hmisc::describe(tira_data) 
```


"table", "summary",  and "describe" functions provide similar output to the "tabulate", "summarize", and "codebook" commands in Stata.

"Summary" and "describe" can be applied to:  

* the whole dataset
* specific variables of interest  

In the example below we look at sex, age and pork in the **tira_data** dataset. You can examine a variable within a dataset using the '$' sign followed by the variable name. 


```{r stegen_hw_difficult-7}
# table will give a very basic frequency table (counts), 
table(tira_data$sex)

# summary gives the mean, median and max values of the specified variable
summary(tira_data$age)

# describe gives the number of data points, missing values and number of categories
describe(tira_data$pork)

```

### b) Create summary tables with counts and proportions

We can create individual tables for each variable with the following steps:

```{r stegen_hw_difficult-9}
# Assign the counts of tira_data$sex to the object "sex"
sex <- table(tira_data$sex)

# Assign the proportion of tira_data$sex to the object "prop" and round the values to 2 decimal places
prop <- round(prop.table(sex)*100, digits = 2)

# Assign the cumulative sum of tira_data$sex to the object "cumul"
cumul <- cumsum(prop)

# Append/row bind the results of the three objects together and assign to the object table1
table1 <- rbind(sex,prop,cumul)
```

```{r stegen_hw_difficult-10}
table1
```

We could also use the big_table function (on page 2), which does all of the above steps in one line.

```{r stegen_hw_difficult-11}
big_table(tira_data$sex)

big_table(tira_data$beer)
```

We could use the big_table function on each of our variables, or we could use a **for loop** to loop through our variables (similar to Stata) with the big_table function.

```{r stegen_hw_difficult-12}
# List the variables of interest and use c() to combine the elements into a vector
vars <- c("ill", "tira", "beer", "pork", "salmon")

# Create an empty list to hold the output of your loop
output <- list() 

# Apply big_table to each element of the object in vars. In this loop, "var" is the indexing variable; any character can be used e.g. "i"
for (var in vars) {
  # Within the [], the item before the comma refers to rows and the item after the comma refers to columns
  total <- big_table(tira_data[,var])
  # assign the value of your tables (total) to the output list (note: double square brackets "[[]]" are used to subset elements of a list)
  output[[var]] <- total
}

output
```

### c) Make box plot and histogram of age

You can use the following to examine the age distribution among people who attended the party, as well as only those and who fell ill and additionally to save the chart. 

```{r stegen_hw_difficult-13}
# Boxplot of the age of all who attended the party
boxplot(tira_data$age)
```


```{r stegen_hw_difficult-14, eval = FALSE}
# Histogram of the ages of those who attended the party and who fell ill

# To save the histogram, the file path and filename must be specified prior to running the histogram code

# This function changes the "graphics device" to jpeg. You can view the current graphics device using dev.curr().  The default in R Studio is "RStudioGD", i.e. the viewing panel where plots normally occ

jpeg(filename = "N:/MED/IMED-VIE/INFE/Public/CC-INFE-Schmid/EPIET/Learning R/R Case studies/MVA module 2016/Homework/age_cases.jpeg")

# Here we use the hist function to plot the age of cases only (ill == 1)
# You will see that RStudio creates a jpeg file in your working directory with the above path and filename.
age_hist_all <- hist(tira_data$age[tira_data$ill == 1],
                     xlab = "Age",
                     ylab = "No. of cases",
                   main = "Histogram of the ages of cases")

# This function closes the graphics device and returns to the default
dev.off()
```

```{r stegen_hw_difficult-15, echo = FALSE}
age_hist_all <- hist(tira_data$age[tira_data$ill == 1],
                     xlab = "Age",
                     ylab = "No. of cases",
                   main = "Histogram of the ages of cases")

```

If we believe that there are two identifiable age groups, then we can create a new age group variable using **one** of the following approaches:

```{r stegen_hw_difficult-16}
# by using ifelse (similar to Excel if statements)
tira_data$agegroup <- ifelse(tira_data$age >= 30, 1, 0)
```
```{r stegen_hw_difficult-17, eval = FALSE}
# Two alternative approaches
# The below are particularly useful when you want to create more than 2 categories
# by using cut
tira_data$agegroup <- cut(tira_data$age, c(0,30,150), labels = FALSE) - 1
# by using findInterval
tira_data$agegroup <- findInterval(tira_data$age, c(30,150))

```

### d) Number of cases by date of onset

You can produce summary tables by person and time (no place variable provided) using the big_table function.

```{r stegen_hw_difficult-18}
# Table 1: Descriptive epidemiology: Study population by sex
big_table(tira_data$sex)

# Table 2: Descriptive epidemiology: Study population by age group
# useNA ="always" here allows you to see the proportion of NAs for this variable
big_table(tira_data$agegroup, useNA = "always")

summary(tira_data$age)
        

# Table 3: Descriptive epidemiology: Attack rate
big_table(tira_data$ill)


# Table 4: Descriptive epidemiology: Cases by date of onset of illness
big_table(tira_data$dateonset)
```
